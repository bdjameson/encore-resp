---
title: "Thermal Performance Curves"
author: "Brett D. Jameson"
date: "16/05/2023"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

# load packages
library(rTPC)
library(nls.multstart)
library(broom)
library(tidyverse)

```

## Fitting thermal performance curves using rTPC

Code scripts for fitting thermal performance curves using rTPC and nls.multstart. This method uses nonlinear least squares regression (NLLS) for fitting of up to 24 different TPC models, and addresses probelms associated with selection of starting values. rTPC also includes functionality for estimating key TPC parameters, calculating error in parameter estimates, and propagation of error estimates onto the model fits. Code scripts and workflows are adapted from Padfield et al. (2020).

First, available model formulations can be viewed using get_model_names()

```{r Print model formulations}
get_model_names()
```

## Introduction vignettes

Example curve fitting procedure using example dataset "chorella_tpc". This file contains 60 TPCs of respiration and photocynthesis of aquatic algae, Chlorella vulgaris. Dataplots are generated using ggplot2.

```{r Data import and visualization, echo=FALSE}
data("chlorella_tpc")

# keep just a single curve
d <- filter(chlorella_tpc, curve_id == 1)

# show the data
ggplot(d, aes(temp, rate)) +
  geom_point() +
  theme_bw(base_size = 12) +
  labs(x = 'Temperature (ºC)',
       y = 'Metabolic rate',
       title = 'Respiration across temperatures')
```

For each of the 24 models, rTPC contains functions that will estimate reasonable start values, and upper and lower limits. Demonstration is performed using the sharpe-schoolfield model for high temperature inactivation.

```{r Estimate starting values, echo=FALSE}
# choose model
mod = 'sharpschoolhigh_1981'

# get start vals
start_vals <- get_start_vals(d$temp, d$rate, model_name = 'sharpeschoolhigh_1981')

# get limits
low_lims <- get_lower_lims(d$temp, d$rate, model_name = 'sharpeschoolhigh_1981')
upper_lims <- get_upper_lims(d$temp, d$rate, model_name = 'sharpeschoolhigh_1981')

# print values
start_vals
low_lims
upper_lims
```

A common issue with fitting NLLS regression models in R is that they are sensitive to the choice of starting parameters. The R package nls.multstart package is used to overcome this issue, which uses minpackLM::nlsLM() but allows for multiple sets of starting parameters. The best model is selected from a larger set of models containing various starting parameters based on AIC scores.

```{r Sample model fitting, echo=FALSE}
# fit model
fit <- nls_multstart(rate~sharpeschoolhigh_1981(temp = temp, r_tref,e,eh,th, tref = 15),
                                                     data = d,
                                                     iter = 500,
                                                     start_lower = start_vals - 10,
                                                     start_upper = start_vals + 10,
                                                     lower = low_lims,
                                                     upper = upper_lims,
                                                     supp_errors = 'Y')

fit
```

Once we have a model selected, we can calculate other model parameters of interest by employing rTPC::calc_params(). This function uses predictions of the fitted model to estimate TPC traits such as optimum temperature (Topt).

```{r Calculate TPC traits, echo+FALSE}
# calculate additional traits
calc_params(fit) %>%
  # round for easy viewing
  mutate_all(round, 2)
```
Finally, we can round out the introduction by obtaining model predictions using broom::augment(), which is similar to the familiar predict() function. The model predictions are then plotted over the original data using ggplot2.

```{r Model prediction and plotting, echo=FALSE}
# predict new data
new_data <- data.frame(temp = seq(min(d$temp), max(d$temp), 0.5))
preds <- augment(fit, newdata = new_data)

# plot data and model fit
ggplot(d, aes(temp, rate)) +
  geom_point() +
  geom_line(aes(temp, .fitted), preds, col = 'blue') +
  theme_bw(base_size = 12) +
  labs(x = 'Temperature (ºC)',
       y = 'Metabolic rate',
       title = 'Respiration across temperatures')
```

