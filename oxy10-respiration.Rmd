---
title: "Oxy10 Respiration"
author: "Brett D. Jameson"
date: "11/05/2023"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Coral Respiration Data Analysis

This file contains code scripts for processing, visualization, and analysis of coral respiration data obtained from the PreSens Oxy10 Respiration chamber system.

## Read and combine all data files

First we need to read all of the discrete Oxy10 data files for each run and combine them into a single dataframe. We will use the filename as the initial identifier.

```{r Oxy10 Data, include=FALSE}
library(data.table)  
library(plyr)
library(dplyr)

files <- list.files(path = "./oxy10-data/oxy10-thermal-stress/", pattern = ".csv")
setwd("./oxy10-data/oxy10-thermal-stress/")
oxy10 <- rbindlist(sapply(files, fread, simplify = FALSE), idcol = 'filename')
```

## Data processing and cleaning 

Now we can separate the filename into discrete columns using "_" as the identifier allowing us to parse each Oxy10 run by the coral species and fragment IDs.

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.

```{r Data trim and clean, include=FALSE}
library(tidyverse)

colnames(oxy10) <- make.unique(colnames(oxy10))

oxy10_clean <- oxy10 %>% 
  separate(filename, 
  into = c('Instrument', 'Date.NA', 'Run', 'Chamber', 'Species', 'FragmentID'), sep = "_")

oxy10_clean$FragmentID <- gsub("\\..*", "", as.character(oxy10_clean$FragmentID))

oxy10_clean <- oxy10_clean %>% # Select relevant columns
  select(Run, Chamber, Species, FragmentID, Date, Time, Channel, delta_t, Time_Unit, Value, Temp, Salinity)

oxy10_clean <- oxy10_clean %>% # move Date to first position
  dplyr::select("Date", everything())

oxy10_clean <- oxy10_clean %>%
  rename(Oxygen_uM = Value)
```

## Processing and analysis of respirometry data

Now that we data merged from all Oxy10 runs we can explore the raw data. First we will subset the main data into the descrete time points and then plot the raw data using ggplot2. 

```{r Data subsetting}
T0 <- oxy10_clean %>% 
    subset(Date== "09/28/2022" | Date=="09/29/2022" | Date=="09/30/2022" & FragmentID != "insitu")

T0_situ <- oxy10_clean %>% 
  subset(Date== "09/30/2022" & FragmentID == "insitu")

T1 <- oxy10_clean %>% 
    subset(Date== "10/12/2022" | Date=="10/13/2022" | Date=="10/14/2022" & FragmentID != "insitu")

T1_situ <- oxy10_clean %>% 
    subset(Date== "10/14/2022" & FragmentID == "insitu")

T2 <- oxy10_clean %>% 
    subset(Date== "10/19/2022" | Date=="10/20/2022" & FragmentID != "insitu")

T3 <- oxy10_clean %>% 
    subset(Date== "10/30/2022" | Date=="10/31/2022" | Date=="11/01/2022" & FragmentID != "insitu")

T3_situ <- oxy10_clean %>% 
  subset(Date== "10/30/2022"  & FragmentID == "insitu")

T4 <- oxy10_clean %>% 
    subset(Date== "11/15/2022" | Date=="10/16/2022" & FragmentID != "insitu")

T4_situ <- oxy10_clean %>% 
  subset(Date== "11/16/2022"  & FragmentID == "insitu")
```

```{r Raw data plots}
ggplot(T0, aes(delta_t, Oxygen_uM)) +
  geom_path() +
  facet_wrap(~FragmentID, scales = "free")

ggplot(T0_situ, aes(delta_t, Oxygen_uM)) +
  geom_path() +
  facet_wrap(~Species, scales = "free")

ggplot(T1, aes(delta_t, Oxygen_uM)) +
  geom_path() +
  facet_wrap(~FragmentID, scales = "free")

ggplot(T1_situ, aes(delta_t, Oxygen_uM)) +
  geom_path() +
  facet_wrap(~Species, scales = "free")

ggplot(T2, aes(delta_t, Oxygen_uM)) +
  geom_path() +
  facet_wrap(~FragmentID, scales = "free")

ggplot(T3, aes(delta_t, Oxygen_uM)) +
  geom_path() +
  facet_wrap(~FragmentID, scales = "free")

ggplot(T3_situ, aes(delta_t, Oxygen_uM)) +
  geom_path() +
  facet_wrap(~Species, scales = "free")

ggplot(T4, aes(delta_t, Oxygen_uM)) +
  geom_path() +
  facet_wrap(~FragmentID, scales = "free")

ggplot(T4_situ, aes(delta_t, Oxygen_uM)) +
  geom_path() +
  facet_wrap(~Species, scales = "free")

# Testing repo move/rename changes.
```

